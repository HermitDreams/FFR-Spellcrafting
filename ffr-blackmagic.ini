[aliases]
n0=/bmag { ; Final Fantasy Randomizer Black Magic Generator. IRC script by Linkshot
n1=  ; Black Spell Initiation
n2=  :blackmagic
n3=  write -c BlackSpell.txt
n4=  var %ffrbmstrskip 0
n5=  var %ffrbmaccskip 0
n6=  var %ffrbmeffect $rand(1,2)
n7=  var %ffrbmohko $rand(1,9)
n8=  var %ffrbmalter $rand(1,2)
n9=  var %ffrbmdebuff $rand(1,12)
n10=  var %ffrbmbuff $rand(1,5)
n11=  var %ffrbmelement $rand(0,8)
n12=  var %ffrbmtarget $rand(1,2)
n13=  var %ffrbmaccroll $rand(0,255)
n14=  var %ffrbmaccuracy $rand($calc((2^$rand(5,6))-1),$calc((2^$rand(1,8))-1))
n15=  var %ffrbmaccsay Undefined
n16=  if (%ffrspellbinding = 1) {
n17=    if (%ffrsplevel = 8) { var %ffrbmstrength 100 }
n18=    else { var %ffrbmstrength $calc( %ffrsplevel * 10) }
n19=  }
n20=  else { var %ffrbmstrength $rand(10,100) }
n21=  var %ffrbmafflict $rand(1,9)
n22=  var %ffrbmpoison $rand(1,5)  
n23=  :bmbase
n24=
n25=  ; -b2: Preserves all slots with damage spells
n26=  if (b2 isincs %ffrspflags) && (%ffrspreroll < 5) {
n27=    if ((%ffrspslot = 1) && (%ffrsplevel != 4)) || ((%ffrsplevel = 1) && (%ffrspslot = 4)) || ((%ffrsplevel = 3) && (%ffrspslot = 3)) || ((%ffrsplevel = 4) && (%ffrspslot = 4)) {
n28=      var %ffrbmeffect 1
n29=      var %ffrbmohko $rand(4,8)
n30=      var %ffrbmb2 1
n31=    }
n32=  }
n33=
n34=  ; Sets Accuracy to Auto-Hit
n35=  if (%ffrbmaccroll < 2) || (%ffrbmaccroll = 148) || (%ffrbmaccsay = Auto-Hit) {
n36=    if (%ffrbmeffect = 1) && (%ffrbmohko < 4) { echo 11 -s Debug: Rejected Auto-Hit on Insta-Kill }
n37=    else { var %ffrbmaccsay Auto-Hit }
n38=  }
n39=  elseif (%ffrspellbinding = 1) {
n40=    if (%ffrsplevel < 5) { var %ffrbmaccuracy 5 | set %ffrbmtier 2 }
n41=    if (%ffrsplevel > 4) { var %ffrbmaccuracy 7 | set %ffrbmtier 3 }
n42=    if (%ffrsplevel = 1) { var %ffrbmaccuracy 4 | set %ffrbmtier 1 }
n43=    if (%ffrsplevel = 8) { var %ffrbmaccuracy 9 | set %ffrbmtier 4 }
n44=  }
n45=  else { var %ffrbmaccsay %ffrbmaccuracy }
n46=
n47=  ; Ensure Confused ailment never casts a buff on self
n48=
n49=  if (C isincs %ffrspflags) && (%ffrspreroll < 5) && (%ffrsplevel = 1) && (%ffrspslot = 1) && (%ffrbmeffect = 2) && (%ffrbmalter = 2) {
n50=    if (%ffrbmbuff = 1) { var %ffrbmdebug ARM }
n51=    elseif (%ffrbmbuff = 2) { var %ffrbmdebug resistance }
n52=    elseif (%ffrbmbuff = 3) { var %ffrbmdebug FAST }
n53=    elseif (%ffrbmbuff = 4) { var %ffrbmdebug TMPR }
n54=    elseif (%ffrbmbuff = 5) { var %ffrbmdebug HIDE }
n55=    else { var %ffrbmdebug Undefined Buff }
n56=    echo 11 -s Debug: Bounced %ffrbmdebug from FIRE slot
n57=    goto blackmagic
n58=  }
n59=
n60=  ; Compatibility with the LOK2 fix
n61=
n62=  if (S isincs %ffrspflags) && (%ffrspreroll < 5) && (%ffrsplevel = 3) && (%ffrspslot = 4) { var %ffrbmeffect 2 | var %ffrbmalter 1 | var %ffrbmdebuff 10 }
n63=
n64=  ; Spell-building
n65=
n66=  ; Black Magic is half Offensive Spells
n67=  ; The other half is Stat Alterations
n68=
n69=  ; 3 in 8 Offensive Spells are Insta-Kills
n70=  ; They have a lowered chance to multi-target
n71=  ; However, Damage Spells have a boosted chance
n72=  if (%ffrbmeffect = 1) {
n73=    if (%ffrbmohko < 4) {
n74=      if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 2 }
n75=      var %ffrbmstrskip 1
n76=      dec %ffrbmtarget $rand(0,1)
n77=      write -al2 BlackSpell.txt Type: Insta-Kill
n78=    }
n79=    else {
n80=      inc %ffrbmtarget $rand(0,1)
n81=      write -al2 BlackSpell.txt Type: Damage
n82=      if (%ffrspellbinding = 1) {
n83=        if (%ffrsplevel = 2) { dec %ffrbmaccuracy 1 }
n84=        if (%ffrbmtarget = 1) && (%ffrsplevel = 8) { inc %ffrbmstrength 20 }
n85=      }
n86=      else {
n87=        if (%ffrbmtarget = 1) { var %ffrbmstrength $floor($calc( %ffrbmstrength * ($calc( $rand(100,150) /100)))) }
n88=      }
n89=      if (%ffrbmstrength isnum 30-49) { set %ffrbmtier 2 }
n90=      elseif (%ffrbmstrength isnum 50-99) { set %ffrbmtier 3 }
n91=      elseif (%ffrbmstrength >= 100) { set %ffrbmtier 4 }
n92=      else { set %ffrbmtier 1 }
n93=    }
n94=  }
n95=  ; Decides whether the Alteration is a buff or debuff
n96=  ; Buffs are rarer than Debuffs
n97=  elseif (%ffrbmeffect = 2) { 
n98=    if (%ffrbmalter = 1) { write -al2 BlackSpell.txt Type: Debuff }
n99=    elseif (%ffrbmalter = 2) {
n100=      if ($rand(0,1) = 0) {
n101=        dec %ffrbmalter 1
n102=        echo 11 -s Debug: Shifting Buff to Debuff
n103=        goto bmbase
n104=      }
n105=      else { echo 7 -s Debug: Buff passed saving roll ( $+ $v1 vs 0) }
n106=      write -al2 BlackSpell.txt Type: Buff
n107=    }
n108=    else { echo 4 -s Value out of range | /halt }
n109=  }
n110=  else { echo 4 -s Value out of range | /halt }
n111=
n112=  ; Stat Alterations
n113=
n114=  if (%ffrbmeffect = 2) {
n115=    if (%ffrbmalter = 1) {
n116=      ; Debug /echo 7 -s Debug: Passing through Debuff (Debuff: %ffrbmdebuff $+ , Element: %ffrbmelement $+ , Poison: %ffrbmpoison $+ )
n117=      if (%ffrspellbinding = 1) && (%ffrbmaccsay = Auto-Hit) && (%ffrbmdebuff < 8) { var %ffrbmdebuff 12 }
n118=      if (%ffrbmdebuff !isnum 9-10) { var %ffrbmstrskip 1 }
n119=      if (%ffrbmdebuff = 1) {
n120=        if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n121=        if (%ffrbmpoison = 1) { write -al3 BlackSpell.txt Effect: Dark & Poison }
n122=        elseif (%ffrbmpoison = 2) { write -al3 BlackSpell.txt Effect: Stun & Poison }
n123=        elseif (%ffrbmpoison = 3) { 
n124=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 1 }
n125=          if (%ffrsplevel > 1) { inc %ffrbmaccuracy 2 }
n126=          write -al3 BlackSpell.txt Effect: Sleep & Poison
n127=        }
n128=        elseif (%ffrbmpoison = 4) {
n129=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n130=          write -al3 BlackSpell.txt Effect: Mute & Poison
n131=        }
n132=        elseif (%ffrbmpoison = 5) {
n133=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 4 }
n134=          write -al3 BlackSpell.txt Effect: Confuse & Poison
n135=        }
n136=        ; Poison Debuff is always stacked on top
n137=        ; So that the spell is useful to players
n138=        if (%ffrbmelement = 3) { write -al4 BlackSpell.txt Element: Time }
n139=        elseif (%ffrbmelement = 4) { write -al4 BlackSpell.txt Element: Death }
n140=        elseif (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n141=        elseif (%ffrbmelement = 0) { write -al4 BlackSpell.txt Element: None }
n142=        else { write -al4 BlackSpell.txt Element: Poison }
n143=        ; Poisons come in Time, Death, and Fire flavours
n144=        ; But mostly Poison
n145=      }
n146=      elseif (%ffrbmdebuff = 2) { 
n147=        write -al3 BlackSpell.txt Effect: Dark
n148=        if (%ffrbmelement = 2) {
n149=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n150=          write -al4 BlackSpell.txt Element: Poison
n151=        }
n152=        elseif (%ffrbmelement = 3) {
n153=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n154=          write -al4 BlackSpell.txt Element: Time
n155=        }
n156=        elseif (%ffrbmelement = 8) {
n157=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n158=          write -al4 BlackSpell.txt Element: Earth
n159=        }
n160=        elseif (%ffrbmelement = 0) { write -al4 BlackSpell.txt Element: None }
n161=        else { write -al4 BlackSpell.txt Element: Status }
n162=        ; Darkness comes in Poison, Time, and Earth flavours
n163=        ; But mostly Status
n164=      }
n165=      elseif (%ffrbmdebuff = 3) {
n166=        write -al3 BlackSpell.txt Effect: Stun
n167=        if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 3 }
n168=        if (%ffrbmelement = 3) {
n169=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 4 }
n170=          write -al4 BlackSpell.txt Element: Time
n171=        }
n172=        elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n173=        elseif (%ffrbmelement = 7) { write -al4 BlackSpell.txt Element: Lit }
n174=        elseif (%ffrbmelement = 0) {
n175=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 5 }
n176=          write -al4 BlackSpell.txt Element: None
n177=        }
n178=        else { write -al4 BlackSpell.txt Element: Status }
n179=        ; Stuns come in Time, Ice, and Lit flavours
n180=        ; But mostly Status
n181=        ; (Change made in May 2019) Black gets an accuracy bonus (redesigned in Dec 2021)
n182=      }
n183=      elseif (%ffrbmdebuff = 4) {
n184=        if (%ffrspellbinding = 1) {
n185=          inc %ffrbmaccuracy 1
n186=          if (%ffrsplevel > 1) { inc %ffrbmaccuracy 2 }
n187=        }
n188=        write -al3 BlackSpell.txt Effect: Sleep
n189=        if (%ffrbmelement = 1) { write -al4 BlackSpell.txt Element: Status }
n190=        elseif (%ffrbmelement = 3) {
n191=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n192=          write -al4 BlackSpell.txt Element: Time
n193=        }
n194=        elseif (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n195=        elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n196=        else { write -al4 BlackSpell.txt Element: None }
n197=        ; Sleep comes in Status, Time, Fire, and Ice flavours
n198=        ; But mostly Non-Elemental
n199=      }
n200=      elseif (%ffrbmdebuff = 5) {
n201=        write -al3 BlackSpell.txt Effect: Mute
n202=        if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n203=        if (%ffrbmelement = 2) {
n204=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n205=          write -al4 BlackSpell.txt Element: Poison
n206=        }
n207=        elseif (%ffrbmelement = 3) {
n208=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n209=          write -al4 BlackSpell.txt Element: Time
n210=        }
n211=        elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n212=        elseif (%ffrbmelement = 0) { write -al4 BlackSpell.txt Element: None }
n213=        else { write -al4 BlackSpell.txt Element: Status }
n214=        ; Mutes come in Poison, Time, and Ice flavours
n215=        ; But mostly Status
n216=      }
n217=      elseif (%ffrbmdebuff = 6) {
n218=        if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 4 }
n219=        write -al3 BlackSpell.txt Effect: Confuse
n220=        if (%ffrbmelement = 3) {
n221=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n222=          write -al4 BlackSpell.txt Element: Time
n223=        }
n224=        elseif (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n225=        elseif (%ffrbmelement = 7) { write -al4 BlackSpell.txt Element: Lit }
n226=        elseif (%ffrbmelement = 0) { write -al4 BlackSpell.txt Element: None }
n227=        else { write -al4 BlackSpell.txt Element: Status }
n228=        ; Confuse comes in Time, Fire, and Lit flavours
n229=        ; But mostly Status
n230=        ; (Change made in May 2019) Black gets an accuracy bonus
n231=      }
n232=      elseif (%ffrbmdebuff = 7) {
n233=        if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n234=        write -al3 BlackSpell.txt Effect: Dehab
n235=        if (%ffrbmelement = 3) {
n236=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n237=          write -al4 BlackSpell.txt Element: Time
n238=        }
n239=        elseif (%ffrbmelement = 4) {
n240=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n241=          write -al4 BlackSpell.txt Element: Death
n242=        }
n243=        elseif (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n244=        elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n245=        elseif (%ffrbmelement = 7) { write -al4 BlackSpell.txt Element: Lit }
n246=        elseif (%ffrbmelement = 8) {
n247=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n248=          write -al4 BlackSpell.txt Element: Earth
n249=        }
n250=        elseif (%ffrbmelement = 0) { write -al4 BlackSpell.txt Element: None }
n251=        else { write -al4 BlackSpell.txt Element: Status }
n252=        ; "Dehab" inflicts everything except Death, Stone, Poison, and Confuse
n253=        ; As such, it doesn't come in Poison flavour
n254=      }
n255=      elseif (%ffrbmdebuff = 8) {
n256=        if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 4 }
n257=        write -al3 BlackSpell.txt Effect: Slow
n258=        if (%ffrbmelement = 1) { write -al4 BlackSpell.txt Element: Status }
n259=        elseif (%ffrbmelement = 2) {
n260=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n261=          write -al4 BlackSpell.txt Element: Poison
n262=        }
n263=        elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n264=        elseif (%ffrbmelement = 4) {
n265=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n266=          write -al4 BlackSpell.txt Element: Death
n267=        }
n268=        elseif (%ffrbmelement = 0) {
n269=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 3 }
n270=          write -al4 BlackSpell.txt Element: None
n271=        }
n272=        else {
n273=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n274=          write -al4 BlackSpell.txt Element: Time
n275=        }
n276=        ; Slows come in Status, Poison, Ice, and Death flavours
n277=        ; But are usually Time
n278=      }
n279=      elseif (%ffrbmdebuff = 9) {
n280=        if (%ffrspellbinding = 1) {
n281=          dec %ffrbmaccuracy 2
n282=          if (%ffrsplevel > 6) { var %ffrbmstrength $rand(40,64) | set %ffrbmtier 4 }
n283=          else {
n284=            var %ffrbmstrength $floor($calc((%ffrsplevel +1)*5))
n285=            if (%ffrbmstrength < 40) { set %ffrbmtier 3 }
n286=            if (%ffrbmstrength < 30) { set %ffrbmtier 2 }
n287=            if (%ffrbmstrength < 20) { set %ffrbmtier 1 }
n288=          }
n289=        }
n290=        write -al3 BlackSpell.txt Effect: Fear
n291=        if (%ffrbmelement = 4) {
n292=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n293=          var %ffrbmstrength $floor($calc(%ffrbmstrength *1.2))
n294=          write -al4 BlackSpell.txt Element: Death
n295=        }
n296=        elseif (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n297=        elseif (%ffrbmelement = 8) {
n298=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n299=          write -al4 BlackSpell.txt Element: Earth
n300=        }
n301=        elseif (%ffrbmelement = 1) { write -al4 BlackSpell.txt Element: Status }
n302=        else { write -al4 BlackSpell.txt Element: None }
n303=        ; Fears come in Death, Fire, Earth, and Status flavours
n304=        ; But usually aren't elemental
n305=      }
n306=      elseif (%ffrbmdebuff = 10) {
n307=        if (%ffrspellbinding = 1) {
n308=          inc %ffrbmaccuracy 4
n309=          if (%ffrsplevel = 8) { var %ffrbmstrength $rand(160,240) | set %ffrbmtier 4 }
n310=          else { var %ffrbmstrength $floor($calc(%ffrsplevel *20)) }
n311=          if (%ffrbmstrength < 160) { set %ffrbmtier 3 }
n312=          if (%ffrbmstrength < 100) { set %ffrbmtier 2 }
n313=          if (%ffrbmstrength < 60) { set %ffrbmtier 1 }
n314=        }
n315=        write -al3 BlackSpell.txt Effect: Locked
n316=        if (%ffrbmelement = 3) {
n317=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n318=          write -al4 BlackSpell.txt Element: Time
n319=        }
n320=        elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n321=        elseif (%ffrbmelement = 7) { write -al4 BlackSpell.txt Element: Lit }
n322=        elseif (%ffrbmelement = 8) {
n323=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n324=          write -al4 BlackSpell.txt Element: Earth
n325=        }
n326=        else { write -al4 BlackSpell.txt Element: None }
n327=        ; Locks come in Time, Ice, Lit, and Earth flavours
n328=        ; But usually aren't elemental
n329=        ; (Change made in May 2019) Black gets an accuracy bonus (redesigned in Dec 2021)
n330=      }
n331=      elseif (%ffrbmdebuff = 11) {
n332=        if (%ffrspellbinding = 1) {
n333=          inc %ffrbmaccuracy 1
n334=          if (%ffrsplevel = 8) { dec %ffrbmaccuracy 1 }
n335=        }
n336=        write -al3 BlackSpell.txt Effect: Dispel
n337=        if (%ffrbmelement = 3) {
n338=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n339=          write -al4 BlackSpell.txt Element: Time
n340=        }
n341=        elseif (%ffrbmelement = 4) {
n342=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n343=          write -al4 BlackSpell.txt Element: Death
n344=        }
n345=        elseif (%ffrbmelement = 7) { write -al4 BlackSpell.txt Element: Lit }
n346=        elseif (%ffrbmelement = 1) { write -al4 BlackSpell.txt Element: Status }
n347=        else {
n348=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 2 }
n349=          write -al4 BlackSpell.txt Element: None
n350=        }
n351=        ; Dispel is the Black name for Xfer
n352=        ; (White calls it Stripped)
n353=        ; Curiously, it can be Time, Death, Lit, or Status
n354=        ; It usually doesn't have an element, thankfully
n355=      }
n356=      ; Power Words get different elemental selection
n357=      elseif (%ffrbmdebuff = 12) {
n358=        if (%ffrspellbinding = 1) && (%ffrsplevel < 6) { echo 11 -s Debug: Bounced a Power Word before Level 6 | goto blackmagic }
n359=        var %ffrbmaccskip 1
n360=        if (%ffrbmafflict = 9) {
n361=          write -a13 BlackSpell.txt Effect: Power Word "Debilitate"
n362=          if (%ffrbmelement = 0) && ($rand(1,5) = 5) { write -al4 BlackSpell.txt Element: None }
n363=          elseif (%ffrbmelement = 3) && ($rand(1,4) = 4) { write -al4 BlackSpell.txt Element: Time }
n364=          elseif (%ffrbmelement = 4) { write -al4 BlackSpell.txt Element: Death }
n365=          else { write -al4 BlackSpell.txt Element: Status }
n366=          ; Dehab heavily favours Status now
n367=          ; But it can still be Time or Death
n368=        }
n369=        elseif (%ffrbmafflict = 1) {
n370=          write -al3 BlackSpell.txt Effect: Power Word "Kill"
n371=          if (%ffrbmelement = 2) { write -al4 BlackSpell.txt Element: Poison }
n372=          elseif (%ffrbmelement = 3) && ($rand(1,5) = 5) { write -al4 BlackSpell.txt Element: Time }
n373=          elseif (%ffrbmelement = 8) { write -al4 BlackSpell.txt Element: Earth }
n374=          elseif (%ffrbmelement = 0) && ($rand(1,10) = 10) { write -al4 BlackSpell.txt Element: None }
n375=          else { write -al4 BlackSpell.txt Element: Death }
n376=          ; Usually, "Kill" is RUB
n377=          ; Sometimes it pulls QAKE, BANE, or ZAP! now
n378=        }
n379=        elseif (%ffrbmafflict = 2) {
n380=          write -al3 BlackSpell.txt Effect: Power Word "Break"
n381=          if (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n382=          elseif (%ffrbmelement = 0) && ($rand(1,10) = 10) { write -al4 BlackSpell.txt Element: None }
n383=          else { write -al4 BlackSpell.txt Element: Stone }
n384=          ; Oh, and Power Words can cast BRAK too
n385=          ; As well as an Ice variant
n386=        }
n387=        elseif (%ffrbmafflict = 3) || (%ffrbmafflict = 8) {
n388=          write -al3 BlackSpell.txt Effect: Power Word "Decay"
n389=          if (%ffrbmelement = 3) && ($rand(1,2) = 2) { write -al4 BlackSpell.txt Element: Time }
n390=          elseif (%ffrbmelement = 4) { write -al4 BlackSpell.txt Element: Death }
n391=          elseif (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n392=          elseif (%ffrbmelement = 0) && ($rand(1,4) = 4) { write -al4 BlackSpell.txt Element: None }
n393=          else { write -al4 BlackSpell.txt Element: Poison }
n394=          ; Poison and Confuse are two sides of the same coin
n395=          ; One ticks down players, the other does enemies
n396=          ; So Power Word "Decay" bundles them into one
n397=          ; It can be Time, Death, or even Fire!
n398=          ; Usually just Poison though
n399=        }
n400=        elseif (%ffrbmafflict = 4) {
n401=          write -al3 BlackSpell.txt Effect: Power Word "Blind"
n402=          if (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n403=          elseif (%ffrbmelement = 7) { write -al4 BlackSpell.txt Element: Lit }
n404=          elseif (%ffrbmelement = 0) { write -al4 BlackSpell.txt Element: None }
n405=          else { write -al4 BlackSpell.txt Element: Status }
n406=          ; BLND has a fairly poor rep, being Darkness
n407=          ; so the Power Word gets to be Fire or Lit
n408=          ; usually just ends up being Status though
n409=        }
n410=        elseif (%ffrbmafflict = 5) {
n411=          write -al3 BlackSpell.txt Effect: Power Word "Stun"
n412=          if (%ffrbmelement = 3) && ($rand(1,2) = 2) { write -al4 BlackSpell.txt Element: Time }
n413=          elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n414=          elseif (%ffrbmelement = 7) { write -al4 BlackSpell.txt Element: Lit }
n415=          elseif (%ffrbmelement = 0) && ($rand(1,4) = 4) { write -al4 BlackSpell.txt Element: None }
n416=          else { write -al4 BlackSpell.txt Element: Status }
n417=          ; STUN also gets privilege like BLND
n418=          ; It can be Ice or Lit now
n419=          ; Still, usually just Status
n420=        }
n421=        elseif (%ffrbmafflict = 6) || (%ffrbmafflict = 7) {
n422=          write -al3 BlackSpell.txt Effect: Power Word "Coma"
n423=          if (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n424=          elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n425=          elseif (%ffrbmelement = 0) { write -al4 BlackSpell.txt Element: None }
n426=          else { write -al4 BlackSpell.txt Element: Status }
n427=          ; Nobody cares about Sleep
n428=          ; Even as a Power Word it's not powerful
n429=          ; So it was bundled in with Mute
n430=          ; It can be Fire or Ice elements
n431=          ; Usually just Status
n432=        }
n433=      }
n434=    }
n435=
n436=    ; Buffs
n437=    ; Black Magic isn't known for being helpful
n438=    ; All Buffs have initial power cut in half
n439=
n440=    ; Process jumps back to here if FAST needs to reroll
n441=    ; so that it doesn't throw away a lot of buffs
n442=    :fastreroll
n443=    if (%ffrbmalter = 2) { 
n444=      var %ffrbmstrength $floor($calc(%ffrbmstrength /2))
n445=      var %ffrbmaccskip 1
n446=      if (%ffrbmbuff = 1) {
n447=        var %ffrbmtarget 2
n448=        write -al3 BlackSpell.txt Effect: Absorb Up
n449=        if (%ffrspellbinding = 1) {
n450=          if (%ffrsplevel = 8) { var %ffrbmstrength 24 | set %ffrbmtier 4 }
n451=          if (%ffrsplevel < 8) { var %ffrbmstrength 16 | set %ffrbmtier 3 }
n452=          if (%ffrsplevel < 5) { var %ffrbmstrength 12 | set %ffrbmtier 2 }
n453=          if (%ffrsplevel < 3) { var %ffrbmstrength 8 | set %ffrbmtier 1 }
n454=        }
n455=        else { var %ffrbmstrength $ceil($calc(%ffrbmstrength * $rand(8,11)/10)) }
n456=      }
n457=      elseif (%ffrbmbuff = 2) {
n458=        if (%ffrspresist > 4) {
n459=          echo 4 -s Resists already capped! Rerolling.
n460=          goto blackmagic
n461=        }
n462=        var %ffrbmstrskip 1
n463=        if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 2-4)) || ((%ffrspellbinding != 1) && (%ffrbmstrength isnum 10-24)) { var %ffrbmtarget 2 }
n464=        else { var %ffrbmtarget 1 }
n465=        if ((%ffrspellbinding = 1) && (%ffrsplevel = 8)) || ((%ffrspellbinding != 1) && ($rand(1,8) = 8)) {
n466=          if (%ffrspwall != 3) {
n467=            set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend all
n468=            set %ffrspwall 3
n469=            inc %ffrspresist 1
n470=          }
n471=          write -al3 BlackSpell.txt Effect: Resist All
n472=          goto barrskip
n473=        }
n474=        if (%ffrbmelement = 1) {
n475=          var %ffrbmresist Status
n476=          if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 5-7)) || ((%ffrspellbinding != 1) && (%ffrbmstrength > 24)) { var %ffrspresmagic 1 }
n477=          else {
n478=            if (%ffrspantiweak != 4) {
n479=              if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend hindrance }
n480=              elseif (%ffrspresist isnum 1-3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend weak }
n481=              else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend psi }
n482=              set %ffrspantiweak 4
n483=              inc %ffrspresist 1
n484=            }
n485=          }
n486=        }
n487=        elseif (%ffrbmelement = 2) {
n488=          var %ffrbmresist Poison/Stone
n489=          if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 5-7)) || ((%ffrspellbinding != 1) && (%ffrbmstrength > 24)) { var %ffrspresdecay 1 }
n490=          else {
n491=            if (%ffrspantibane != 5) {
n492=              if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend poisonous }
n493=              elseif (%ffrspresist isnum 1-3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend bane }
n494=              else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend gas }
n495=              set %ffrspantibane 5
n496=              inc %ffrspresist 1
n497=            }
n498=          }
n499=        }
n500=        elseif (%ffrbmelement = 3) {
n501=          var %ffrbmresist Time
n502=          if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 5-7)) || ((%ffrspellbinding != 1) && (%ffrbmstrength > 24)) { var %ffrspresdecay 1 }
n503=          else {
n504=            if (%ffrspantizap != 5) {
n505=              if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend dimension }
n506=              elseif (%ffrspresist isnum 1-3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend time }
n507=              else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend age }
n508=              set %ffrspantizap 5
n509=              inc %ffrspresist 1
n510=            }
n511=          }
n512=        }
n513=        elseif (%ffrbmelement = 4) {
n514=          var %ffrbmresist Death
n515=          if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 5-7)) || ((%ffrspellbinding != 1) && (%ffrbmstrength > 24)) {
n516=            if ($rand(1,2) = 1) { var %ffrspresmagic 1 }
n517=            else { var %ffrspresdecay 1 }
n518=          }
n519=          else {
n520=            if (%ffrspantinecro != 4) {
n521=              if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend necrotic }
n522=              elseif (%ffrspresist isnum 1-3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend evil }
n523=              else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend rub }
n524=              set %ffrspantinecro 4
n525=              inc %ffrspresist 1
n526=            }
n527=          }
n528=        }
n529=        elseif (%ffrbmelement = 5) {
n530=          var %ffrbmresist Fire
n531=          if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 5-7)) || ((%ffrspellbinding != 1) && (%ffrbmstrength > 24)) { var %ffrspresdragon 1 }
n532=          else {
n533=            if (%ffrspantifire != 4) {
n534=              if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend burning }
n535=              elseif (%ffrspresist isnum 1-3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend fire }
n536=              else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend hot }
n537=              set %ffrspantifire 4
n538=              inc %ffrspresist 1
n539=            }
n540=          }
n541=        }
n542=        elseif (%ffrbmelement = 6) {
n543=          var %ffrbmresist Ice
n544=          if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 5-7)) || ((%ffrspellbinding != 1) && (%ffrbmstrength > 24)) { var %ffrspresdragon 1 }
n545=          else {
n546=            if (%ffrspantiice != 4) {
n547=              if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend freezing }
n548=              elseif (%ffrspresist isnum 1-3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend cold }
n549=              else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend ice }
n550=              set %ffrspantiice 4
n551=              inc %ffrspresist 1
n552=            }
n553=          }
n554=        }
n555=        elseif (%ffrbmelement = 7) {
n556=          var %ffrbmresist Lit
n557=          if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 5-7)) || ((%ffrspellbinding != 1) && (%ffrbmstrength > 24)) { var %ffrspresdragon 1 }
n558=          else {
n559=            if (%ffrspantilightning != 9) {
n560=              if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend lightning }
n561=              elseif (%ffrspresist isnum 1-3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend volt }
n562=              else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend ion }
n563=              set %ffrspantilightning 9
n564=              inc %ffrspresist 1
n565=            }
n566=          }
n567=        }
n568=        elseif (%ffrbmelement = 8) {
n569=          var %ffrbmresist Earth
n570=          if ((%ffrspellbinding = 1) && (%ffrsplevel isnum 5-7)) || ((%ffrspellbinding != 1) && (%ffrbmstrength > 24)) { var %ffrspresmagic 1 }
n571=          else {
n572=            if (%ffrspantiquake != 5) {
n573=              if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend tectonic }
n574=              elseif (%ffrspresist isnum 1-3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend land }
n575=              else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend geo }
n576=              set %ffrspantiquake 5
n577=              inc %ffrspresist 1
n578=            }
n579=          }
n580=        }
n581=        else {
n582=          var %ffrbmstrskip 0
n583=          write -al3 BlackSpell.txt Effect: Regenerate
n584=          if (%ffrspellbinding = 1) { set %ffrbmregmod %ffrsplevel }
n585=          else { set %ffrbmregmod $calc(%ffrbmstrength /6) }
n586=          var %ffrbmstrength $floor($calc(($rand(18,22) /10)^ ($rand(25,40) /10 + %ffrbmregmod / 2) + (%ffrbmregmod - 1) /2 ))
n587=          if (%ffrspellbinding = 1) {
n588=            if (%ffrsplevel < 7) { set %ffrbmtier 3 }
n589=            if (%ffrsplevel < 5) { set %ffrbmtier 2 }
n590=            if (%ffrsplevel < 3) { set %ffrbmtier 1 }
n591=          }
n592=          else { set %ffrbmtier $ceil($calc(%ffrbmstrength / $rand(32,64)))
n593=            if (%ffrbmtier > 3) { echo 7 -s Regen Power: %ffrbmstrength }
n594=          }
n595=        }
n596=        if (%ffrspresmagic = 1) {
n597=          var %ffrbmresist Magic
n598=          if (%ffrspantimagic != 5) {
n599=            if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend mortality }
n600=            elseif (%ffrspresist isnum 1-2) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend life }
n601=            elseif (%ffrspresist = 3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend magic }
n602=            else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend bio }
n603=            set %ffrspantimagic 5
n604=            inc %ffrspresist 1
n605=          }
n606=        }
n607=        elseif (%ffrspresdecay = 1) {
n608=          var %ffrbmresist Decay
n609=          if (%ffrspantitoxin != 5) {
n610=            if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend futility }
n611=            elseif (%ffrspresist isnum 1-2) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend doom }
n612=            elseif (%ffrspresist = 3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend waste }
n613=            else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend rot }
n614=            set %ffrspantitoxin 5
n615=            inc %ffrspresist 1
n616=          }
n617=        }
n618=        elseif (%ffrspresdragon = 1) {
n619=          var %ffrbmresist Dragon
n620=          if (%ffrspantidamage != 5) {
n621=            if (%ffrspresist = 0) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend elemental }
n622=            elseif (%ffrspresist isnum 1-2) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend wyrm }
n623=            elseif (%ffrspresist = 3) { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend spell }
n624=            else { set %ffrspresmsg $+ $calc(%ffrspresist +1) Defend wiz }
n625=            set %ffrspantidamage 5
n626=            inc %ffrspresist 1
n627=          }
n628=        }
n629=        if (%ffrbmelement isnum 1-8) { write -al3 BlackSpell.txt Effect: Resist %ffrbmresist }
n630=      }
n631=      elseif (%ffrbmbuff = 3) {
n632=        ; if (%ffrspellbinding != 1) {
n633=        ;   if ($rand(0,1) = 1) { var %ffrbmbuff $rand(1,5) | /echo 11 -s Debug: Rerolling failed FAST (0 vs $v1 $+ ) | goto fastreroll }
n634=        ; }
n635=        ; if ($rand(1,20) > $rand(1,100)) { var %ffrbmtarget 3 | /echo 7 Debug: Passed FURY roll ( $+ $v1 vs $v2 $+ ) }
n636=        if ((%ffrspellbinding != 1) && (%ffrbmstrength < 25)) || ((%ffrspellbinding = 1) && (%ffrsplevel < 4)) { var %ffrbmtarget 1 }
n637=        elseif ((%ffrspellbinding != 1) && (%ffrbmstrength >= 40)) || ((%ffrspellbinding = 1) && (%ffrsplevel > 7)) { var %ffrbmtarget 3 }
n638=        else { var %ffrbmtarget 2 }
n639=        ; Trying out power-based FAST targetting rather than random
n640=        var %ffrbmstrskip 1
n641=        write -al3 BlackSpell.txt Effect: Double Hits
n642=        ; However, Black Magic likes to hurt things
n643=        ; FAST hurts things. A lot.
n644=        ; To prevent most buffs just rolling FAST,
n645=        ; it has to win a coinflip to pass
n646=        ; Also has a 20% chance to boost the whole party
n647=      }
n648=      elseif (%ffrbmbuff = 4) {
n649=        write -al3 BlackSpell.txt Effect: Attack Up 
n650=        if (%ffrbmtarget > 1) {
n651=          if (%ffrspellbinding = 1) {
n652=            var %ffrbmstrength $floor($calc(%ffrsplevel *3+ $rand(3,5)))
n653=            if (%ffrbmstrength < 27) { set %ffrbmtier 3 }
n654=            else { set %ffrbmtier 4 }
n655=            if (%ffrbmstrength < 18) { set %ffrbmtier 2 }
n656=            if (%ffrbmstrength < 12) { set %ffrbmtier 1 }
n657=          }
n658=          else { var %ffrbmstrength $calc($rand(5,19) + $rand(1,10)) }
n659=          if ($rand(1,20) > $rand(1,50)) {
n660=            var %ffrbmtarget 3
n661=            if (%ffrspellbinding = 1) { var %ffrbmstrength $floor($calc(%ffrbmstrength / (($rand(100,120) /10 - %ffrsplevel)/2)+5)) }
n662=            else { var %ffrbmstrength $ceil($calc(%ffrbmstrength * ($rand(75,100)/100))) }
n663=          }
n664=          else { /echo 7 Debug: RALY failed ( $+ $v1 vs $v2 $+ ) }
n665=        }
n666=        ; TMPR hurts things too
n667=        ; It comes in varying strengths so no coinflip
n668=        ; It use its own dice, which end up between
n669=        ; 6 and 29, averaging high teens to low 20s
n670=        else {
n671=          if (%ffrspellbinding = 1) {
n672=            var %ffrbmstrength $floor($calc(2^(1.5+ %ffrsplevel /2) +(9- %ffrsplevel)+ %ffrsplevel /2))
n673=            if (%ffrbmstrength < 50) { set %ffrbmtier 3 }
n674=            else { set %ffrbmtier 4 }
n675=            if (%ffrbmstrength < 22) { set %ffrbmtier 2 }
n676=            if (%ffrbmstrength < 15) { set %ffrbmtier 1 }
n677=          }
n678=          else { var %ffrbmstrength $rand(5,50) }
n679=        }
n680=        ; SABR is allowed to wildly vary from 5 to 50
n681=      }
n682=      elseif (%ffrbmbuff = 5) {
n683=        var %ffrbmtarget 2
n684=        write -al3 BlackSpell.txt Effect: Evade Up
n685=        if (%ffrspellbinding = 1) {
n686=          if (%ffrsplevel = 8) { var %ffrbmstrength 80 | set %ffrbmtier 4 }
n687=          if (%ffrsplevel < 8) { var %ffrbmstrength 60 | set %ffrbmtier 3 }
n688=          if (%ffrsplevel < 5) { var %ffrbmstrength 40 | set %ffrbmtier 2 }
n689=          if (%ffrsplevel < 3) { var %ffrbmstrength 30 | set %ffrbmtier 1 }
n690=        }
n691=        else { var %ffrbmstrength $floor($calc(%ffrbmstrength * $rand(10,18)/10)) }
n692=      }
n693=    }
n694=  }
n695=
n696=  ; Offensive Spells need Elements too
n697=  ; Black Magic is better at damaging
n698=  ; So it never uses Status, Time, or Earth
n699=  ; Those instead give more weight to Fire, Ice, and Lit
n700=  ; It has a bit of a fetish for Poison and Death though
n701=  ; Death hits harder
n702=
n703=  ; Non-elemental Instakills have to pass a 10% check
n704=  ; Fire, Ice, and Lit Instakills have to pass 25%
n705=  ; Smoke=Poison, Break=Stone, Exile=Time, Erase=Death
n706=  ; So Ice inflicts Stone and requires Softening
n707=  if (%ffrbmeffect = 1) {
n708=    if (%ffrbmohko < 4) { 
n709=      :blackohko
n710=      if (%ffrbmelement = 0) {
n711=        if ($rand(1,10) = 10) { write -al4 BlackSpell.txt Element: None }
n712=        else {
n713=          /echo 11 -s Debug: FALL failed ( $+ $v1 vs 10). Switching to QAKE.
n714=          var %ffrbmelement 8
n715=          goto blackohko
n716=        }
n717=      }
n718=      elseif (%ffrbmelement = 1) {
n719=        if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n720=        write -al4 BlackSpell.txt Element: Smoke
n721=      }
n722=      elseif (%ffrbmelement = 2) {
n723=        if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 3 }
n724=        write -al4 BlackSpell.txt Element: Break
n725=      }
n726=      elseif (%ffrbmelement = 3) {
n727=        if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n728=        write -al4 BlackSpell.txt Element: Exile
n729=      }
n730=      elseif (%ffrbmelement = 4) {
n731=        if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n732=        write -al4 BlackSpell.txt Element: Erase
n733=      }
n734=      elseif (%ffrbmelement = 5) {
n735=        if ($rand(1,4) = 4) { write -al4 BlackSpell.txt Element: Fire }
n736=        ; Use "Erased"
n737=        else { /echo 11 -s Debug: MELT failed ( $+ $v1 vs 4). Switching to RUB.
n738=          var %ffrbmelement 4
n739=          goto blackohko
n740=        }
n741=      }
n742=      elseif (%ffrbmelement = 6) {
n743=        if ($rand(1,4) = 4) {
n744=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 1 }
n745=          write -al4 BlackSpell.txt Element: Ice
n746=        }
n747=        ; Use "Broken"
n748=        else { /echo 11 -s Debug: CRYO failed ( $+ $v1 vs 4). Switching to a poison.
n749=          var %ffrbmelement $rand(1,2)
n750=          goto blackohko
n751=        }
n752=      }
n753=      elseif (%ffrbmelement = 7) {
n754=        if ($rand(1,4) = 4) { write -al4 BlackSpell.txt Element: Lit }
n755=        ; Use "Exiled"
n756=        else { /echo 11 -s Debug: SMIT failed ( $+ $v1 vs 4). Switching to ZAP!
n757=          var %ffrbmelement 3
n758=          goto blackohko
n759=        }
n760=      }
n761=      elseif (%ffrbmelement = 8) {
n762=        if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n763=        write -al4 BlackSpell.txt Element: Crack
n764=      }
n765=    }
n766=    else {
n767=      if ($rand(1,3) = 3) { echo 11 -s Debug: Forcing element to Fire, Ice, or Lit ( $+ $v1 vs 3) | var %ffrbmelement $rand(5,7) }
n768=      :blackdamage
n769=      if (%ffrbmelement = 1) {
n770=        if ($rand(1,20) > $rand(1,60)) {
n771=          var %ffrbmstrength $floor($calc(%ffrbmstrength *1.25))
n772=          write -al4 BlackSpell.txt Element: Kinetic
n773=        }
n774=        else {
n775=          write -al4 BlackSpell.txt Element: Lit
n776=          echo 11 -s Debug: Kinetic failed ( $+ $v1 vs $v2 $+ )
n777=        }
n778=      }
n779=      elseif (%ffrbmelement = 2) { 
n780=        if ($rand(1,20) > $rand(1,60)) { 
n781=          var %ffrbmstrength $floor($calc(%ffrbmstrength *1.1))
n782=          write -al4 BlackSpell.txt Element: Storm
n783=        }
n784=        else {
n785=          echo 11 -s Debug: Storm failed ( $+ $v1 vs $v2 $+ )
n786=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 2 }
n787=          write -al4 BlackSpell.txt Element: Poison
n788=        }
n789=      }
n790=      elseif (%ffrbmelement = 3) {
n791=        if ($rand(1,20) > $rand(1,60)) {
n792=          var %ffrbmstrength $floor($calc(%ffrbmstrength *1.1))
n793=          write -al4 BlackSpell.txt Element: Plasma
n794=        }
n795=        else {
n796=          write -al4 BlackSpell.txt Element: Ice
n797=          echo 11 -s Debug: Plasma failed ( $+ $v1 vs $v2 $+ )
n798=        }
n799=      }
n800=      elseif (%ffrbmelement = 4) {
n801=        if ($rand(1,20) > $rand(1,60)) { 
n802=          var %ffrbmstrength $floor($calc(%ffrbmstrength *1.25))
n803=          write -al4 BlackSpell.txt Element: Antipode
n804=        }
n805=        else {
n806=          echo 11 -s Debug: Antipode failed ( $+ $v1 vs $v2 $+ )
n807=          if (%ffrspellbinding = 1) { dec %ffrbmaccuracy 1 }
n808=          var %ffrbmstrength $floor($calc( %ffrbmstrength * 1.2 ))
n809=          if (%ffrbmstrength = 144) { dec %ffrbmstrength 24 }
n810=          write -al4 BlackSpell.txt Element: Death
n811=        }
n812=      }
n813=      elseif (%ffrbmelement = 5) { write -al4 BlackSpell.txt Element: Fire }
n814=      elseif (%ffrbmelement = 6) { write -al4 BlackSpell.txt Element: Ice }
n815=      elseif (%ffrbmelement = 7) { write -al4 BlackSpell.txt Element: Lit }
n816=      elseif (%ffrbmelement = 8) {
n817=        if ($rand(1,20) > $rand(1,60)) {
n818=          var %ffrbmstrength $floor($calc(%ffrbmstrength *1.25))
n819=          write -al4 BlackSpell.txt Element: Magma
n820=        }
n821=        else {
n822=          echo 11 -s Debug: Magma failed ( $+ $v1 vs $v2 $+ )
n823=          write -al4 BlackSpell.txt Element: Fire
n824=        }
n825=      }
n826=      else {
n827=        if ($rand(1,20) >= $rand(1,20)) { 
n828=          write -al4 BlackSpell.txt Element: None
n829=          if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 1 }
n830=        }
n831=        else { /echo 11 -s Debug: NUKE failed ( $+ $v1 vs $v2 $+ ). Switching to basic element.
n832=          var %ffrbmelement $rand(5,7)
n833=          goto blackdamage
n834=        }
n835=      }
n836=    }
n837=  }
n838=
n839=  ; -b2: Ensuring targeting remains
n840=
n841=  if (%ffrbmb2 = 1) {
n842=    if (%ffrsplevel isnum 1-2) { var %ffrbmtarget 1 }
n843=    elseif (%ffrsplevel isnum 3-7) { var %ffrbmtarget 2 }
n844=  }
n845=
n846=  ; Writes the target down to a file
n847=  ; First checks if FAST or TMPR is AoE
n848=  ; Then checks if it's a Buff or not
n849=  ; Only TMPR and FAST can target all allies
n850=  :barrskip
n851=  if (%ffrbmeffect = 2) && (%ffrbmtarget = 3) { write -al5 BlackSpell.txt Target: All Allies | goto targetjump }
n852=  if (%ffrbmeffect = 1) || ((%ffrbmeffect = 2) && (%ffrbmalter = 1)) {
n853=    if (%ffrbmtarget < 2) {
n854=      if (%ffrspellbinding = 1) { inc %ffrbmaccuracy 1 }
n855=      write -al5 BlackSpell.txt Target: Single Enemy
n856=    }
n857=    elseif (%ffrbmtarget > 1) { write -al5 BlackSpell.txt Target: Enemy Party }
n858=  }
n859=  elseif (%ffrbmeffect = 2) && (%ffrbmalter = 2) {
n860=    if (%ffrbmtarget = 1) { write -al5 BlackSpell.txt Target: Caster }
n861=    elseif (%ffrbmtarget = 2) { write -al5 BlackSpell.txt Target: Single Ally }
n862=  }
n863=  ; This just makes sure it doesn't overwrite All Allies
n864=  :targetjump
n865=
n866=  ; Accuracy Balance
n867=  ; Defines the appropriate tiers of Accuracy for Spellbooks
n868=  ; Accuracy no longer caps
n869=  ; Instakills can't be Auto-Hit
n870=  if (%ffrspellbinding = 1) && (%ffrbmaccsay = Undefined) {
n871=    if (%ffrbmaccuracy < 2) { var %ffrbmaccsay 0 }
n872=    elseif (%ffrbmaccuracy = 2) { var %ffrbmaccsay 5 }
n873=    elseif (%ffrbmaccuracy = 3) { var %ffrbmaccsay 8 }
n874=    elseif (%ffrbmaccuracy = 4) { var %ffrbmaccsay 16 }
n875=    elseif (%ffrbmaccuracy = 5) { var %ffrbmaccsay 24 }
n876=    elseif (%ffrbmaccuracy = 6) { var %ffrbmaccsay 32 }
n877=    elseif (%ffrbmaccuracy = 7) { var %ffrbmaccsay 40 }
n878=    elseif (%ffrbmaccuracy = 8) { var %ffrbmaccsay 48 }
n879=    elseif (%ffrbmaccuracy = 9) { var %ffrbmaccsay 64 }
n880=    elseif (%ffrbmaccuracy = 10) { var %ffrbmaccsay 107 }
n881=    elseif (%ffrbmaccuracy = 11) { var %ffrbmaccsay 128 }
n882=    elseif (%ffrbmaccuracy = 12) { var %ffrbmaccsay 152 }
n883=    elseif (%ffrbmaccuracy = 13) { var %ffrbmaccsay 175 }
n884=    elseif (%ffrbmaccuracy = 14) { var %ffrbmaccsay 210 }
n885=    else { var %ffrbmaccsay 255 | echo 7 -s Debug: Assumed Accuracy was Auto-Hit }
n886=  }
n887=
n888=  ; Cleanup Section
n889=
n890=  ; Outputs only information relevant to the spell
n891=  if (%ffrbmstrskip = 0) && (%ffrbmaccskip = 0) { write -s15 BlackSpell.txt Power: %ffrbmstrength | write -al6 BlackSpell.txt Acc Bonus: %ffrbmaccsay }
n892=  elseif (%ffrbmstrskip = 0) && (%ffrbmaccskip = 1) { write -s15 BlackSpell.txt Power: %ffrbmstrength }
n893=  elseif (%ffrbmstrskip = 1) && (%ffrbmaccskip = 0) { write -s15 BlackSpell.txt Acc Bonus: %ffrbmaccsay }
n894=
n895=  ; Rerolls if spell is incompatible during Spellbinding
n896=  if (e isincs %ffrspflags) && (%ffrspreroll < 5) {
n897=    if (%ffrbmeffect = 2) && (%ffrbmalter = 1) && ((%ffrbmdebuff = 6) || (%ffrbmdebuff = 9)) {
n898=      if (%ffrbmdebuff = 6) { var %ffrbmdebug CONF }
n899=      elseif (%ffrbmdebuff = 9) { var %ffrbmdebug FEAR }
n900=      if (%ffrsplevel = 1) || (%ffrsplevel = 5) || (%ffrsplevel = 8) { /echo 11 -s Debug: Bounced %ffrbmdebug during spellbinding | goto blackmagic }
n901=      elseif ((%ffrsplevel = 4) || (%ffrsplevel = 6) || (%ffrsplevel = 7)) && (%ffrspslot != 3) { /echo 11 -s Debug: Bounced %ffrbmdebug during spellbinding | goto blackmagic }
n902=      elseif (%ffrsplevel = 2) && ((%ffrspslot = 2) || (%ffrspslot = 4)) { /echo 11 -s Debug: Bounced %ffrbmdebug during spellbinding | goto blackmagic }
n903=      elseif (%ffrsplevel = 3) && (%ffrspslot != 4) { /echo 11 -s Debug: Bounced %ffrbmdebug during spellbinding | goto blackmagic }
n904=    }
n905=  }
n906=
n907=  ; Skips text output for Spellbinding
n908=  ; That would open 64 Notepad windows
n909=  ; Also keeps track of AoE Damage Spells
n910=  if (%ffrnowrite != 1) { /run BlackSpell.txt }
n911=  elseif (%ffrbmeffect = 1) && (%ffrbmtarget > 1) && (%ffrbmohko > 3) { inc %ffrspblackAoE 1 }
n912=
n913=}
